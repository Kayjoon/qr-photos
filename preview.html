<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>QR 미리보기 & QR 만들기</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:sans-serif;background:#111;color:#fff;margin:0;padding:20px}
    .container{max-width:900px;margin:0 auto;text-align:center}
    input{padding:8px;font-size:16px;width:160px}
    button{padding:8px 12px;margin-left:8px;font-size:14px}
    #preview img{max-width:45%;margin:10px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    #link{margin-top:12px;font-size:16px}
    #qrcode{margin-top:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>QR 페이지 미리보기</h1>
    <input id="idInput" type="text" placeholder="예: 5">
    <button id="btnPreview">미리보기</button>
    <button id="btnCopy" style="display:none">링크 복사</button>
    <button id="btnDL" style="display:none">QR 다운로드</button>
    <div id="preview"></div>
    <div id="link"></div>
    <div id="qrcode"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    const btn = document.getElementById('btnPreview');
    const idInput = document.getElementById('idInput');
    const preview = document.getElementById('preview');
    const linkDiv = document.getElementById('link');
    const qrDiv = document.getElementById('qrcode');
    const btnCopy = document.getElementById('btnCopy');
    const btnDL = document.getElementById('btnDL');
    let currentCanvas = null;

    async function loadPreview(){
      const id = idInput.value.trim();
      if(!id){ alert("ID 입력하세요"); return; }
      preview.innerHTML = '로딩...'; linkDiv.innerHTML=''; qrDiv.innerHTML=''; btnCopy.style.display='none'; btnDL.style.display='none'; currentCanvas=null;

      try {
        const r = await fetch(`/content/photos/${encodeURIComponent(id)}.json`);
        if(r.ok){
          const data = await r.json();
          preview.innerHTML = '';
          [data.image1, data.image2].forEach(src=>{
            if(src){
              const img = document.createElement('img'); img.src = src; preview.appendChild(img);
            }
          });
          const url = `${location.origin}/${id}`;
          linkDiv.innerHTML = `<p><a href="${url}" target="_blank">${url}</a></p>`;
          makeQR(url);
          return;
        }
      } catch(e){}

      const p1 = `/photos/${id}/1.jpg`;
      const p2 = `/photos/${id}/2.jpg`;
      const ok1 = await fetch(p1,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
      const ok2 = await fetch(p2,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
      preview.innerHTML = '';
      if(ok1){ const img=document.createElement('img'); img.src=p1; preview.appendChild(img); }
      if(ok2){ const img=document.createElement('img'); img.src=p2; preview.appendChild(img); }
      if(!ok1 && !ok2){ preview.innerHTML='사진 없음'; return; }
      const url = `${location.origin}/${id}`;
      linkDiv.innerHTML = `<p><a href="${url}" target="_blank">${url}</a></p>`;
      makeQR(url);
    }

    function makeQR(url){
      qrDiv.innerHTML='';
      const canvas = document.createElement('canvas');
      new QRious({ element: canvas, value: url, size: 300 });
      qrDiv.appendChild(canvas);
      currentCanvas = canvas;
      btnCopy.style.display='inline-block';
      btnDL.style.display='inline-block';
    }

    btn.addEventListener('click', loadPreview);
    btnCopy.addEventListener('click', ()=>{
      const id = idInput.value.trim();
      if(!id) return;
      const url = `${location.origin}/${id}`;
      navigator.clipboard.writeText(url).then(()=> alert('링크 복사됨'));
    });
    btnDL.addEventListener('click', ()=>{
      if(!currentCanvas) return;
      const dataUrl = currentCanvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `qr-${idInput.value.trim()}.png`;
      document.body.appendChild(a); a.click(); a.remove();
    });
  </script>
</body>
</html>
